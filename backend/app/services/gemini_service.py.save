"""
Gemini API通信サービス
"""

import asyncio
import google.generativeai as genai
from app.config import settings
pyenv shell 3.13.7
from ..utils.exceptions import GeminiAPIError


class GeminiService:
    """Gemini API通信管理"""
    
    def __init__(self):
        """初期化"""
        if not settings.GEMINI_API_KEY:
            raise ValueError("GEMINI_API_KEY環境変数が設定されていません")
        
        # Gemini APIの初期化
        try:
            genai.configure(api_key=settings.GEMINI_API_KEY)
            # 安定性の高い最新モデルを使用
            self.model = genai.GenerativeModel('gemini-2.5-flash')
        except Exception as e:
            raise GeminiAPIError(f"Gemini API 初期化エラー: {str(e)}")
        
        self.timeout = settings.AI_REQUEST_TIMEOUT
    
    async def generate_travel_plan(
        self, 
        travel_input, 
        plan_id: str
    ) -> str:
        """
        旅行プラン生成（高レベルAPI）
        
        Gemini APIを呼び出し、生のテキストレスポンスを返します。
        パースは plan_generator.py の parse_gemini_response で行われます。
        """
        try:
            # プロンプト生成
            from .prompts.travel_plan_prompt import create_travel_prompt
            prompt = create_travel_prompt(travel_input)
            
            # API呼び出しをスレッドで実行
            response = await asyncio.to_thread(
                self.model.generate_content,
                prompt,
                generation_config={
                    'temperature': 0.7,
                    'max_output_tokens': 2048,
                }
            )
            
            if not response or not hasattr(response, 'text') or not response.text:
                raise GeminiAPIError("API から有効なテキストレスポンスが得られませんでした")
            
            # ログ保存（オプション）
            try:
                from ..utils.json_handler import save_gemini_log
                await save_gemini_log(plan_id, prompt, {"text": response.text})
            except:
                pass # ログ失敗は無視して続行
                
            return response.text
        
        except Exception as e:
            # ここで発生したエラーが plan.py に伝わり、503エラーの原因になります
            raise GeminiAPIError(f"旅行プラン生成エラー: {type(e).__name__}: {str(e)}")

# インスタンス管理用
_gemini_service = None

def get_gemini_service() -> GeminiService:
    """Gemini Service インスタンスを取得"""
    global _gemini_service
    if _gemini_service is None:
        _gemini_service = GeminiService()
    return _gemini_service
