<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>âœ¨AIæ—…è¡Œãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
      <div class="container">
        <h1 class="logo">âœ¨AIæ—…è¡Œãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
        <p class="subtitle">
          ã‚ãªãŸã®äºˆç®—ã€èˆˆå‘³ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«åˆã‚ã›ã¦ã€AIãŒæœ€é©ãªæ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™
        </p>
      </div>
    </header>
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main id="app-container"></main>

    <script src="js/router.js"></script>
    <script>
      /**
       * ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å€¤ã‚’localStorageã«ä¿å­˜ã—ã€APIã‚’å‘¼ã³å‡ºã™
       */
      async function saveFormToStorage() {
        const form = document.getElementById("travel-form");
        if (!form) return;

        const formData = new FormData(form);
        const data = {
          destination: formData.get("destination") || "",
          budget: formData.get("budget") || "",
          duration: formData.get("duration") || "",
          interests: formData.get("interests") || ""
        };

        // localStorageã«ä¿å­˜
        localStorage.setItem("travelFormData", JSON.stringify(data));

        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API ã‚’å‘¼ã³å‡ºã™
        try {
          const travelPlan = await callPlanGenerationAPI(data);
          // ãƒ—ãƒ©ãƒ³ã‚’localStorageã«ä¿å­˜
          localStorage.setItem("generatedPlan", JSON.stringify(travelPlan));
        } catch (error) {
          console.error("APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:", error);
          // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯è¡¨ç¤ºï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤ºï¼‰
        }
      }

      /**
       * ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ /api/plans API ã‚’å‘¼ã³å‡ºã—
       */
      async function callPlanGenerationAPI(formData) {
        // æ—…è¡Œæ—¥æ•°ã‹ã‚‰é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’è¨ˆç®—
        const today = new Date();
        const start_date = today.toISOString().split('T')[0];
        
        const endDate = new Date(today);
        endDate.setDate(endDate.getDate() + parseInt(formData.duration) - 1);
        const end_date = endDate.toISOString().split('T')[0];

        // API ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿
        const apiRequest = {
          origin: "æ±äº¬",  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºç™ºåœ°
          destination: formData.destination,
          start_date: start_date,
          end_date: end_date,
          budget: parseInt(formData.budget),
          interests: formData.interests ? formData.interests.split("ã€").filter(i => i.trim()) : [],
          additional_notes: ""
        };

        const response = await fetch("http://localhost:8000/api/plans", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(apiRequest)
        });

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        return await response.json();
      }

      /**
       * localStorageã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å€¤ã‚’å¾©å…ƒ
       */
      function restoreFormFromStorage() {
        const form = document.getElementById("travel-form");
        if (!form) return;

        const savedData = localStorage.getItem("travelFormData");
        if (savedData) {
          const data = JSON.parse(savedData);
          document.getElementById("destination").value = data.destination;
          document.getElementById("budget").value = data.budget;
          document.getElementById("duration").value = data.duration;
          document.getElementById("interests").value = data.interests;
        }
      }

      /**
       * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã«å…¥åŠ›å€¤ã¨ç”Ÿæˆãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º
       */
      function displayPreview() {
        const savedData = localStorage.getItem("travelFormData");
        if (!savedData) return;

        const data = JSON.parse(savedData);

        // ãƒ—ãƒ©ãƒ³æ¦‚è¦ã‚’æ›´æ–°
        if (data.destination) {
          document.getElementById("preview-destination").textContent = 
            `${data.destination}ã¸ã®æ—…è¡Œãƒ—ãƒ©ãƒ³`;
        }

        const summaryParts = [];
        if (data.duration) summaryParts.push(`${data.duration}æ—¥é–“`);
        if (data.budget) summaryParts.push(`äºˆç®—: Â¥${parseInt(data.budget).toLocaleString()}`);
        if (summaryParts.length > 0) {
          document.getElementById("preview-summary").textContent = summaryParts.join(" â€¢ ");
        }

        // å…¥åŠ›å€¤è¡¨ç¤º
        document.getElementById("preview-destination-value").textContent = 
          data.destination || "æœªå…¥åŠ›";
        document.getElementById("preview-destination-value").className = 
          `preview-value ${!data.destination ? "empty" : ""}`;

        document.getElementById("preview-budget-value").textContent = 
          data.budget ? `Â¥${parseInt(data.budget).toLocaleString()}` : "æœªå…¥åŠ›";
        document.getElementById("preview-budget-value").className = 
          `preview-value ${!data.budget ? "empty" : ""}`;

        document.getElementById("preview-duration-value").textContent = 
          data.duration ? `${data.duration}æ—¥é–“` : "æœªå…¥åŠ›";
        document.getElementById("preview-duration-value").className = 
          `preview-value ${!data.duration ? "empty" : ""}`;

        document.getElementById("preview-interests-value").textContent = 
          data.interests || "æœªå…¥åŠ›";
        document.getElementById("preview-interests-value").className = 
          `preview-value ${!data.interests ? "empty" : ""}`;

        // ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º
        const generatedPlan = localStorage.getItem("generatedPlan");
        if (generatedPlan) {
          try {
            const plan = JSON.parse(generatedPlan);
            generateSchedulePreview(plan);
          } catch (error) {
            console.error("ãƒ—ãƒ©ãƒ³ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", error);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç°¡æ˜“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
            generateSchedulePreview(data);
          }
        } else {
          // ãƒ—ãƒ©ãƒ³ãŒæœªç”Ÿæˆã®å ´åˆã¯ç°¡æ˜“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
          generateSchedulePreview(data);
        }
      }

      /**
       * æ—¥ç¨‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆï¼ˆAPI ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ã¾ãŸã¯ ç°¡æ˜“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œï¼‰
       */
      function generateSchedulePreview(data) {
        const container = document.getElementById("schedule-preview-container");
        if (!container) return;

        container.innerHTML = "";

        // API ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        if (data.schedules && Array.isArray(data.schedules)) {
          // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼
          displayAPISchedule(data);
        } else {
          // ç°¡æ˜“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å½¢å¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ï¼‰
          displaySimpleSchedule(data);
        }
      }

      /**
       * ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¡¨ç¤º
       */
      function displayAPISchedule(plan) {
        const container = document.getElementById("schedule-preview-container");

        // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
        const titleElement = document.getElementById("schedule-title");
        if (titleElement) {
          titleElement.textContent = "âœ¨ AIãŒç”Ÿæˆã—ãŸæ—…è¡Œãƒ—ãƒ©ãƒ³";
        }

        plan.schedules.forEach(daySchedule => {
          const dayDiv = document.createElement("div");
          dayDiv.className = "day-preview";

          // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼
          const dateStr = new Date(daySchedule.date).toLocaleDateString("ja-JP");
          let content = `<div class="day-preview-header">Day ${daySchedule.day} - ${dateStr}</div>`;

          // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
          if (daySchedule.timeline && Array.isArray(daySchedule.timeline)) {
            daySchedule.timeline.forEach(activity => {
              content += `
                <div class="timeline-item">
                  <div class="timeline-time">${activity.time}</div>
                  <div class="timeline-activity">
                    <div class="activity-name">${activity.activity}</div>
                    <div class="activity-details">
                      <span class="location">ğŸ“ ${activity.location}</span>
                      <span class="cost">Â¥${activity.cost.toLocaleString()}</span>
                      <span class="duration">${activity.duration}åˆ†</span>
                    </div>
                    <div class="activity-notes">${activity.notes}</div>
                  </div>
                </div>
              `;
            });
          }

          // æ—¥æ¯ã®è²»ç”¨
          content += `<div class="day-preview-footer">å°è¨ˆ: Â¥${daySchedule.daily_cost.toLocaleString()}</div>`;

          dayDiv.innerHTML = content;
          container.appendChild(dayDiv);
        });

        // åˆè¨ˆè²»ç”¨ã‚’è¡¨ç¤º
        const totalDiv = document.createElement("div");
        totalDiv.className = "plan-summary-box";
        totalDiv.innerHTML = `
          <div><strong>åˆè¨ˆè²»ç”¨:</strong> Â¥${plan.total_cost.toLocaleString()}</div>
          <div><strong>åˆè¨ˆæ™‚é–“:</strong> ${Math.floor(plan.total_duration / 60)}æ™‚é–“</div>
        `;
        container.appendChild(totalDiv);
      }

      /**
       * ç°¡æ˜“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰ã‚’è¡¨ç¤º
       */
      function displaySimpleSchedule(data) {
        const container = document.getElementById("schedule-preview-container");

        // å…¥åŠ›å€¤ãŒãªã„å ´åˆ
        if (!data.duration || parseInt(data.duration) === 0) {
          container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">æ—…è¡Œæ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
          return;
        }

        const days = parseInt(data.duration);
        const now = new Date();

        // æ—¥ç¨‹ã‚’ç”Ÿæˆ
        for (let i = 0; i < days; i++) {
          const dayDate = new Date(now);
          dayDate.setDate(dayDate.getDate() + i);
          const dateStr = dayDate.toLocaleDateString("ja-JP");

          const dayDiv = document.createElement("div");
          dayDiv.className = "day-preview";

          let activities = [];
          if (data.interests) {
            const interestList = data.interests.split("ã€").slice(0, 2); // æœ€åˆã®2ã¤ã¾ã§
            activities = interestList.map(interest => ({
              name: `${interest}ä½“é¨“`,
              time: `${9 + i}:00ï½${10 + i}:00`
            }));
          }

          let content = `<div class="day-preview-header">${i + 1}æ—¥ç›® - ${dateStr}</div>`;

          if (activities.length > 0) {
            activities.forEach(activity => {
              content += `
                <div class="day-preview-time">${activity.time}</div>
                <div class="day-preview-description">ğŸ·ï¸ ${activity.name}</div>
              `;
            });
          } else {
            content += '<div class="day-preview-description">èˆˆå‘³ãƒ»é–¢å¿ƒã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ—ãƒ©ãƒ³ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™</div>';
          }

          dayDiv.innerHTML = content;
          container.appendChild(dayDiv);
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’å¾©å…ƒ
        restoreFormFromStorage();

        router.loadPage("input-form");

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å¾Œã«ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        router.onPageLoaded = (pageName) => {
          if (pageName === "input-form") {
            const form = document.getElementById("travel-form");
            if (form) {
              // å…¥åŠ›å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§localStorageã«ä¿å­˜
              form.addEventListener("input", saveFormToStorage);

              // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
              form.addEventListener("submit", async (e) => {
                e.preventDefault();
                await saveFormToStorage(); // é€ä¿¡æ™‚ã«ä¿å­˜ã¨ API å‘¼ã³å‡ºã—
                router.loadPage("plan-result").then(() => {
                  displayPreview(); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                });
              });
            }
          } else if (pageName === "plan-result") {
            // plan-result ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã¨ããƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            displayPreview();
          }
        };
      });
    </script>
  </body>
</html>
